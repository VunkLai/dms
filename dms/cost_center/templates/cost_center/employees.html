{% extends "cost_center/layout.html" %}

<!-- Vuetify Data-Table -->

{% block content %}

<v-data-table
  :headers="table.headers"
  :items="table.items"
  sort-by="employee_id"
>
  <template v-slot:top>
    <!-- TopBar -->
    <v-toolbar flat>
      <!-- TopBar title -->
      <v-toolbar-title>Cost Center</v-toolbar-title>
      <v-divider class="mx-4" inset vertical></v-divider>
      <v-spacer></v-spacer>

      <!-- Edit dialog -->
      <v-dialog v-model="dialogEdit" max-width="500px">
        <template v-slot:activator="{ on, attrs }">
          {{ user.username|title }}
        </template>
        <v-card>
          <v-card-title>
            <span class="text-h5"> Edit </span>
          </v-card-title>

          <v-card-text>
            <v-container>
              <v-row>
                <v-col cols="12" sm="6" md="6">
                  <v-text-field
                    v-model="selectedItem.employee_id"
                    label="Employee ID"
                    readonly
                  ></v-text-field>
                </v-col>
                <v-col cols="12" sm="6" md="6">
                  <v-text-field
                    v-model="selectedItem.employee_name"
                    label="Employee Name"
                    readonly
                  ></v-text-field>
                </v-col>
                <v-col cols="12" sm="6" md="6">
                  <v-text-field
                    v-model="selectedItem.department_id"
                    label="Department ID"
                    readonly
                  ></v-text-field>
                </v-col>
                <v-col cols="12" sm="6" md="6">
                  <v-text-field
                    v-model="selectedItem.department_name"
                    label="Department Name"
                    readonly
                  ></v-text-field>
                </v-col>
                <v-col cols="12" sm="12" md="12">
                  <v-text-field
                    v-model="selectedItem.centers"
                    label="Cost Centers"
                  ></v-text-field>
                </v-col>
              </v-row>
            </v-container>
          </v-card-text>

          <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn color="blue darken-1" text @click="cancel"> Cancel </v-btn>
            <v-btn color="blue darken-1" text @click="save"> Save </v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>

      <!-- Delete dialog -->
      <v-dialog v-model="dialogDelete" max-width="500px">
        <v-card>
          <v-card-title class="text-h5">
            Are you sure you want to delete this item?
          </v-card-title>
          <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn color="blue darken-1" text @click="cancel"> Cancel </v-btn>
            <v-btn color="blue darken-1" text @click="confirm"> Delete </v-btn>
            <v-spacer></v-spacer>
          </v-card-actions>
        </v-card>
      </v-dialog>
    </v-toolbar>
  </template>

  <template v-slot:item.actions="{ item }">
    <v-icon small class="mr-2" @click="editItem(item)"> mdi-pencil </v-icon>
    <v-icon small @click="deleteItem(item)"> mdi-delete </v-icon>
  </template>

  <template v-slot:no-data> Oops, Something Went Wrong... </template>
</v-data-table>

{% endblock content %}

<!-- Vue -->

{% block javascript %}
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  new Vue({
    el: "#app",
    delimiters: ["[[", "]]"],
    vuetify: new Vuetify(),
    data: {
      table: {
        headers: [
          { text: "ID", value: "employee_id" },
          { text: "Name", value: "employee_name" },
          { text: "Dep. ID", value: "department_id" },
          { text: "Department", value: "department_name" },
          { text: "Center", value: "centers" },
          { text: "Actions", value: "actions", sortable: false },
        ],
        items: [],
      },
      // dialogs
      dialogEdit: false,
      dialogDelete: false,
      // default items
      defaultItem: {
        employee_id: null,
        employee_name: null,
        department_id: null,
        department_name: null,
        centers: [],
      },
      // selected item and index
      selectedItem: {
        employee_id: null,
        employee_name: null,
        department_id: null,
        department_name: null,
        centers: [],
      },
    },
    watch: {
      dialogEdit(val) {
        if (!val) this.dialogClose();
      },
      dialogDelete(val) {
        if (!val) this.dialogClose();
      },
    },
    created() {
      this.initialize();
    },
    methods: {
      initialize() {
        fetch("http://localhost:8000/cost/employees")
          .then((response) => response.json())
          .then((json) => (this.table.items = json.employees));
      },
      editItem(item) {
        this.selectedItem = Object.assign({}, item);
        this.dialogEdit = true;
      },
      deleteItem(item) {
        this.selectedItem = Object.assign({}, item);
        this.dialogDelete = true;
      },
      cancel() {
        if (this.dialogEdit) this.dialogEdit = false;
        if (this.dialogDelete) this.dialogDelete = false;
      },
      save() {
        console.log("[save]", this.selectedItem);
        fetch(
          `http://localhost:8000/cost/update/${this.selectedItem.employee_id}`,
          {
            method: "POST",
            mode: "same-origin",
            headers: {
              "X-CSRFToken": getCookie("csrftoken"),
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ ...this.selectedItem }),
          }
        )
          .then((response) => {
            return response.json();
          })
          .then((json) => {
            this.dialogEdit = false;
          })
          .catch((err) => console.error(err));
      },
      confirm() {
        console.log("[confirm]", this.selectedItem);
        // fetch("URL", { method: "DELETE" });
        this.dialogDelete = false;
      },
      dialogClose() {
        this.$nextTick(() => {
          this.selectedItem = Object.assign({}, this.defaultItem);
        });
      },
    },
  });
</script>
{% endblock javascript %}
